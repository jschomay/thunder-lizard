var gi=Object.defineProperty;var mi=(s,t,e)=>t in s?gi(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e;var g=(s,t,e)=>mi(s,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const Et=23283064365386963e-26;class ae{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*Et,t=t*69069+1>>>0,this._s1=t*Et,t=t*69069+1>>>0,this._s2=t*Et,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*Et;return this._s0=this._s1,this._s1=this._s2,this._c=t|0,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),n=Math.min(t,e);return Math.floor(this.getUniform()*(i-n+1))+n}getNormal(t=0,e=1){let i,n,r;do i=2*this.getUniform()-1,n=2*this.getUniform()-1,r=i*i+n*n;while(r>1||r==0);let o=i*Math.sqrt(-2*Math.log(r)/r);return t+o*e}getPercentage(){return 1+Math.floor(this.getUniform()*100)}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let n=i.indexOf(this.getItem(i));e.push(i.splice(n,1)[0])}return e}getWeightedValue(t){let e=0;for(let o in t)e+=t[o];let i=this.getUniform()*e,n,r=0;for(n in t)if(r+=t[n],i<r)return n;return n}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return new ae().setState(this.getState())}}const x=new ae().setSeed(Date.now());class le{getContainer(){return null}setOptions(t){this._options=t}}class he extends le{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const i=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=i,this._updateSize(),this._ctx.font=i,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){const t=this._ctx.globalCompositeOperation;this._ctx.globalCompositeOperation="copy",this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.globalCompositeOperation=t}eventToPosition(t,e){let i=this._ctx.canvas,n=i.getBoundingClientRect();return t-=n.left,e-=n.top,t*=i.width/n.width,e*=i.height/n.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}function Kt(s,t){return(s%t+t)%t}function Ae(s,t=0,e=1){return s<t?t:s>e?e:s}class Fe extends he{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,n,r,o,a]=t,l=[(i+1)*this._spacingX,n*this._spacingY+this._hexSize];if(this._options.transpose&&l.reverse(),e&&(this._ctx.fillStyle=a,this._fill(l[0],l[1])),!r)return;this._ctx.fillStyle=o;let h=[].concat(r);for(let c=0;c<h.length;c++)this._ctx.fillText(h[c],l[0],Math.ceil(l[1]))}computeSize(t,e){this._options.transpose&&(t+=e,e=t-e,t-=e);let i=Math.floor(t/this._spacingX)-1,n=Math.floor((e-2*this._hexSize)/this._spacingY+1);return[i,n]}computeFontSize(t,e){this._options.transpose&&(t+=e,e=t-e,t-=e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,n=e/(2+1.5*(this._options.height-1)),r=Math.min(i,n),o=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let a=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=o;let l=a/100;r=Math.floor(r)+1;let h=2*r/(this._options.spacing*(1+l/Math.sqrt(3)));return Math.ceil(h)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,e=t-e,t-=e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let n=i/this._options.height;return e=Math.floor(e/n),Kt(e,2)?(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))):t=2*Math.floor(t/(2*this._spacingX)),[t,e]}_fill(t,e){let i=this._hexSize,n=this._options.border;const r=this._ctx;r.beginPath(),this._options.transpose?(r.moveTo(t-i+n,e),r.lineTo(t-i/2+n,e+this._spacingX-n),r.lineTo(t+i/2-n,e+this._spacingX-n),r.lineTo(t+i-n,e),r.lineTo(t+i/2-n,e-this._spacingX+n),r.lineTo(t-i/2+n,e-this._spacingX+n),r.lineTo(t-i+n,e)):(r.moveTo(t,e-i+n),r.lineTo(t+this._spacingX-n,e-i/2+n),r.lineTo(t+this._spacingX-n,e+i/2-n),r.lineTo(t,e+i-n),r.lineTo(t-this._spacingX+n,e+i/2-n),r.lineTo(t-this._spacingX+n,e-i/2+n),r.lineTo(t,e-i+n)),r.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=this._hexSize*1.5;let i,n;t.transpose?(i="height",n="width"):(i="width",n="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[n]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class St extends he{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){St.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let[e,i,n,r,o]=t,a=""+n+r+o,l;if(a in this._canvasCache)l=this._canvasCache[a];else{let h=this._options.border;l=document.createElement("canvas");let c=l.getContext("2d");if(l.width=this._spacingX,l.height=this._spacingY,c.fillStyle=o,c.fillRect(h,h,l.width-h,l.height-h),n){c.fillStyle=r,c.font=this._ctx.font,c.textAlign="center",c.textBaseline="middle";let u=[].concat(n);for(let p=0;p<u.length;p++)c.fillText(u[p],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=l}this._ctx.drawImage(l,e*this._spacingX,i*this._spacingY)}_drawNoCache(t,e){let[i,n,r,o,a]=t;if(e){let h=this._options.border;this._ctx.fillStyle=a,this._ctx.fillRect(i*this._spacingX+h,n*this._spacingY+h,this._spacingX-h,this._spacingY-h)}if(!r)return;this._ctx.fillStyle=o;let l=[].concat(r);for(let h=0;h<l.length;h++)this._ctx.fillText(l[h],(i+.5)*this._spacingX,Math.ceil((n+.5)*this._spacingY))}computeSize(t,e){let i=Math.floor(t/this._spacingX),n=Math.floor(e/this._spacingY);return[i,n]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),n=Math.floor(e/this._options.height),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let l=o/100*n/i;return l>1&&(n=Math.floor(n/l)),Math.floor(n/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}St.cache=!1;class De extends he{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,n,r,o,a]=t,l=this._options.tileWidth,h=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*l,n*h,l,h):(this._ctx.fillStyle=a,this._ctx.fillRect(i*l,n*h,l,h))),!r)return;let c=[].concat(r),u=[].concat(o),p=[].concat(a);for(let d=0;d<c.length;d++){let f=this._options.tileMap[c[d]];if(!f)throw new Error(`Char "${c[d]}" not found in tileMap`);if(this._options.tileColorize){let _=this._colorCanvas,w=_.getContext("2d");w.globalCompositeOperation="source-over",w.clearRect(0,0,l,h);let m=u[d],b=p[d];w.drawImage(this._options.tileSet,f[0],f[1],l,h,0,0,l,h),m!="transparent"&&(w.fillStyle=m,w.globalCompositeOperation="source-atop",w.fillRect(0,0,l,h)),b!="transparent"&&(w.fillStyle=b,w.globalCompositeOperation="destination-over",w.fillRect(0,0,l,h)),this._ctx.drawImage(_,i*l,n*h,l,h)}else this._ctx.drawImage(this._options.tileSet,f[0],f[1],l,h,i*l,n*h,l,h)}}computeSize(t,e){let i=Math.floor(t/this._options.tileWidth),n=Math.floor(e/this._options.tileHeight);return[i,n]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}function ce(s){let t,e;if(s in Vt)t=Vt[s];else{if(s.charAt(0)=="#"){let n=(s.match(/[0-9a-f]/gi)||[]).map(r=>parseInt(r,16));if(n.length==3)t=n.map(r=>r*17);else{for(let r=0;r<3;r++)n[r+1]+=16*n[r],n.splice(r,1);t=n}}else(e=s.match(/rgb\(([0-9, ]+)\)/i))?t=e[1].split(/\s*,\s*/).map(i=>parseInt(i)):t=[0,0,0];Vt[s]=t}return t.slice()}function _i(s,...t){let e=s.slice();for(let i=0;i<3;i++)for(let n=0;n<t.length;n++)e[i]+=t[n][i];return e}function yi(s,...t){for(let e=0;e<3;e++)for(let i=0;i<t.length;i++)s[e]+=t[i][e];return s}function vi(s,...t){let e=s.slice();for(let i=0;i<3;i++){for(let n=0;n<t.length;n++)e[i]*=t[n][i]/255;e[i]=Math.round(e[i])}return e}function wi(s,...t){for(let e=0;e<3;e++){for(let i=0;i<t.length;i++)s[e]*=t[i][e]/255;s[e]=Math.round(s[e])}return s}function Ne(s,t,e=.5){let i=s.slice();for(let n=0;n<3;n++)i[n]=Math.round(i[n]+e*(t[n]-s[n]));return i}const bi=Ne;function Be(s,t,e=.5){let i=Qt(s),n=Qt(t);for(let r=0;r<3;r++)i[r]+=e*(n[r]-i[r]);return Ue(i)}const xi=Be;function Si(s,t){t instanceof Array||(t=Math.round(x.getNormal(0,t)));let e=s.slice();for(let i=0;i<3;i++)e[i]+=t instanceof Array?Math.round(x.getNormal(0,t[i])):t;return e}function Qt(s){let t=s[0]/255,e=s[1]/255,i=s[2]/255,n=Math.max(t,e,i),r=Math.min(t,e,i),o=0,a,l=(n+r)/2;if(n==r)a=0;else{let h=n-r;switch(a=l>.5?h/(2-n-r):h/(n+r),n){case t:o=(e-i)/h+(e<i?6:0);break;case e:o=(i-t)/h+2;break;case i:o=(t-e)/h+4;break}o/=6}return[o,a,l]}function jt(s,t,e){return e<0&&(e+=1),e>1&&(e-=1),e<1/6?s+(t-s)*6*e:e<1/2?t:e<2/3?s+(t-s)*(2/3-e)*6:s}function Ue(s){let t=s[2];if(s[1]==0)return t=Math.round(t*255),[t,t,t];{let e=s[1],i=t<.5?t*(1+e):t+e-t*e,n=2*t-i,r=jt(n,i,s[0]+1/3),o=jt(n,i,s[0]),a=jt(n,i,s[0]-1/3);return[Math.round(r*255),Math.round(o*255),Math.round(a*255)]}}function Ei(s){return`rgb(${s.map(e=>Ae(e,0,255)).join(",")})`}function Mi(s){return`#${s.map(e=>Ae(e,0,255).toString(16).padStart(2,"0")).join("")}`}const Vt={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]},Ti=Object.freeze(Object.defineProperty({__proto__:null,add:_i,add_:yi,fromString:ce,hsl2rgb:Ue,interpolate:Ne,interpolateHSL:Be,lerp:bi,lerpHSL:xi,multiply:vi,multiply_:wi,randomize:Si,rgb2hsl:Qt,toHex:Mi,toRGB:Ei},Symbol.toStringTag,{value:"Module"}));class je extends le{constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){typeof t=="string"?alert(t):t instanceof Error&&alert(t.message)}}static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",()=>this._updateTexture(e)):this._updateTexture(e)}draw(t,e){const i=this._gl,n=this._options;let[r,o,a,l,h]=t,c=i.canvas.height-(o+1)*n.tileHeight;if(i.scissor(r*n.tileWidth,c,n.tileWidth,n.tileHeight),e&&(n.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...Mt(h)),i.clear(i.COLOR_BUFFER_BIT)),!a)return;let u=[].concat(a),p=[].concat(h),d=[].concat(l);i.uniform2fv(this._uniforms.targetPosRel,[r,o]);for(let f=0;f<u.length;f++){let _=this._options.tileMap[u[f]];if(!_)throw new Error(`Char "${u[f]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,n.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,_),n.tileColorize&&(i.uniform4fv(this._uniforms.tint,Mt(d[f])),i.uniform4fv(this._uniforms.bg,Mt(p[f]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(...Mt(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){let i=Math.floor(t/this._options.tileWidth),n=Math.floor(e/this._options.tileHeight);return[i,n]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,n=i.getBoundingClientRect();return t-=n.left,e-=n.top,t*=i.width/n.width,e*=i.height/n.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=ki(t,Pi,Oi);return t.useProgram(e),zi(t),Ci.forEach(i=>this._uniforms[i]=t.getUniformLocation(e,i)),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){Ii(this._gl,t)}}const Ci=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],Pi=`
#version 300 es

in vec2 tilePosRel;
out vec2 tilesetPosPx;

uniform vec2 tilesetPosAbs;
uniform vec2 tileSize;
uniform vec2 targetSize;
uniform vec2 targetPosRel;

void main() {
	vec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;
	vec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;
	targetPosNdc.y *= -1.0;

	gl_Position = vec4(targetPosNdc, 0.0, 1.0);
	tilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;
}`.trim(),Oi=`
#version 300 es
precision highp float;

in vec2 tilesetPosPx;
out vec4 fragColor;
uniform sampler2D image;
uniform bool colorize;
uniform vec4 bg;
uniform vec4 tint;

void main() {
	fragColor = vec4(0, 0, 0, 1);

	vec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);

	if (colorize) {
		texel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;
		fragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;
		fragColor.a = texel.a + (1.0-texel.a)*bg.a;
	} else {
		fragColor = texel;
	}
}`.trim();function ki(s,t,e){const i=s.createShader(s.VERTEX_SHADER);if(s.shaderSource(i,t),s.compileShader(i),!s.getShaderParameter(i,s.COMPILE_STATUS))throw new Error(s.getShaderInfoLog(i)||"");const n=s.createShader(s.FRAGMENT_SHADER);if(s.shaderSource(n,e),s.compileShader(n),!s.getShaderParameter(n,s.COMPILE_STATUS))throw new Error(s.getShaderInfoLog(n)||"");const r=s.createProgram();if(s.attachShader(r,i),s.attachShader(r,n),s.linkProgram(r),!s.getProgramParameter(r,s.LINK_STATUS))throw new Error(s.getProgramInfoLog(r)||"");return r}function zi(s){const t=new Float32Array([0,0,1,0,0,1,1,1]),e=s.createBuffer();s.bindBuffer(s.ARRAY_BUFFER,e),s.bufferData(s.ARRAY_BUFFER,t,s.STATIC_DRAW),s.enableVertexAttribArray(0),s.vertexAttribPointer(0,2,s.FLOAT,!1,0,0)}function Ii(s,t){let e=s.createTexture();return s.bindTexture(s.TEXTURE_2D,e),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MAG_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_MIN_FILTER,s.NEAREST),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_S,s.REPEAT),s.texParameteri(s.TEXTURE_2D,s.TEXTURE_WRAP_T,s.REPEAT),s.pixelStorei(s.UNPACK_FLIP_Y_WEBGL,0),s.texImage2D(s.TEXTURE_2D,0,s.RGBA,s.RGBA,s.UNSIGNED_BYTE,t),e}let $t={};function Mt(s){if(!(s in $t)){let t;if(s=="transparent")t=[0,0,0,0];else if(s.indexOf("rgba")>-1){t=(s.match(/[\d.]+/g)||[]).map(Number);for(let e=0;e<3;e++)t[e]=t[e]/255}else t=ce(s).map(e=>e/255),t.push(1);$t[s]=t}return $t[s]}function Ri(s){return`\x1B[0;48;5;${Jt(s)}m\x1B[2J`}function Li(s,t){return`\x1B[0;38;5;${Jt(s)};48;5;${Jt(t)}m`}function Xi(s,t){return`\x1B[${t+1};${s+1}H`}function Jt(s){const i=.0234375;let n=ce(s),r=Math.floor(n[0]*i),o=Math.floor(n[1]*i),a=Math.floor(n[2]*i);return r*36+o*6+a*1+16}class Ve extends le{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((n,r)=>Math.floor((n-e[r])/2))}clear(){process.stdout.write(Ri(this._options.bg))}draw(t,e){let[i,n,r,o,a]=t,l=this._offset[0]+i,h=this._offset[1]+n,c=this.computeSize();if(l<0||l>=c[0]||h<0||h>=c[1]||((l!==this._cursor[0]||h!==this._cursor[1])&&(process.stdout.write(Xi(l,h)),this._cursor[0]=l,this._cursor[1]=h),e&&(r||(r=" ")),!r))return;let u=Li(o,a);if(u!==this._lastColor&&(process.stdout.write(u),this._lastColor=u),r!="	"){let p=[].concat(r);process.stdout.write(p[0])}this._cursor[0]++,this._cursor[0]>=c[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const Yi=/%([bc]){([^}]*)}/g,at=0,yt=1,$e=2,We=3;function Ai(s,t){let e=[],i=0;s.replace(Yi,function(r,o,a,l){let h=s.substring(i,l);return h.length&&e.push({type:at,value:h}),e.push({type:o=="c"?$e:We,value:a.trim()}),i=l+r.length,""});let n=s.substring(i);return n.length&&e.push({type:at,value:n}),Fi(e,t)}function Fi(s,t){t||(t=1/0);let e=0,i=0,n=-1;for(;e<s.length;){let o=s[e];if(o.type==yt&&(i=0,n=-1),o.type!=at){e++;continue}for(;i==0&&o.value.charAt(0)==" ";)o.value=o.value.substring(1);let a=o.value.indexOf(`
`);if(a!=-1){o.value=Tt(s,e,a,!0);let l=o.value.split("");for(;l.length&&l[l.length-1]==" ";)l.pop();o.value=l.join("")}if(!o.value.length){s.splice(e,1);continue}if(i+o.value.length>t){let l=-1;for(;;){let h=o.value.indexOf(" ",l+1);if(h==-1||i+h>t)break;l=h}if(l!=-1)o.value=Tt(s,e,l,!0);else if(n!=-1){let h=s[n],c=h.value.lastIndexOf(" ");h.value=Tt(s,n,c,!0),e=n}else o.value=Tt(s,e,t-i,!1)}else i+=o.value.length,o.value.indexOf(" ")!=-1&&(n=e);e++}s.push({type:yt});let r=null;for(let o=0;o<s.length;o++){let a=s[o];switch(a.type){case at:r=a;break;case yt:if(r){let l=r.value.split("");for(;l.length&&l[l.length-1]==" ";)l.pop();r.value=l.join("")}r=null;break}}return s.pop(),s}function Tt(s,t,e,i){let n={type:yt},r={type:at,value:s[t].value.substring(e+(i?1:0))};return s.splice(t+1,0,n,r),s[t].value.substring(0,e)}let Di=80,Ni=25;const C={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},Bi={hex:Fe,rect:St,tile:De,"tile-gl":je,term:Ve},Ui={width:Di,height:Ni,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class ht{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},Ui,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let n=[this._options.bg,this._options.fg];this.draw(t,e,null,null,n[i%n.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=Bi[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){let i=Math.floor(t/this._options.width),n=Math.floor(e/this._options.height);return[i,n]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,n,r){n||(n=this._options.fg),r||(r=this._options.bg);let o=`${t},${e}`;this._data[o]=[t,e,i,n,r],this._dirty!==!0&&(this._dirty||(this._dirty={}),this._dirty[o]=!0)}drawOver(t,e,i,n,r){const o=`${t},${e}`,a=this._data[o];a?(a[2]=i||a[2],a[3]=n||a[3],a[4]=r||a[4]):this.draw(t,e,i,n,r)}drawText(t,e,i,n){let r=null,o=null,a=t,l=e,h=1;n||(n=this._options.width-t);let c=Ai(i,n);for(;c.length;){let u=c.shift();switch(u.type){case at:let p=!1,d=!1,f=!1,_=!1;for(let w=0;w<u.value.length;w++){let m=u.value.charCodeAt(w),b=u.value.charAt(w);if(this._options.layout==="term"){let S=m>>8;if(S===17||S>=46&&S<=159||S>=172&&S<=215||m>=43360&&m<=43391){this.draw(a+0,l,b,r,o),this.draw(a+1,l,"	",r,o),a+=2;continue}}f=m>65280&&m<65377||m>65500&&m<65512||m>65518,p=b.charCodeAt(0)==32||b.charCodeAt(0)==12288,_&&!f&&!p&&a++,f&&!d&&a++,this.draw(a++,l,b,r,o),d=p,_=f}break;case $e:r=u.value||null;break;case We:o=u.value||null;break;case yt:a=t,l++,h++;break}}return h}_tick(){if(this._backend.schedule(this._tick),!!this._dirty){if(this._dirty===!0){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}ht.Rect=St;ht.Hex=Fe;ht.Tile=De;ht.TileGL=je;ht.Term=Ve;class xe{constructor(){this.heap=[],this.timestamp=0}lessThan(t,e){return t.key==e.key?t.timestamp<e.timestamp:t.key<e.key}shift(t){this.heap=this.heap.map(({key:e,value:i,timestamp:n})=>({key:e+t,value:i,timestamp:n}))}len(){return this.heap.length}push(t,e){this.timestamp+=1;const i=this.len();this.heap.push({value:t,timestamp:this.timestamp,key:e}),this.updateUp(i)}pop(){if(this.len()==0)throw new Error("no element to pop");const t=this.heap[0];return this.len()>1?(this.heap[0]=this.heap.pop(),this.updateDown(0)):this.heap.pop(),t}find(t){for(let e=0;e<this.len();e++)if(t==this.heap[e].value)return this.heap[e];return null}remove(t){let e=null;for(let i=0;i<this.len();i++)t==this.heap[i].value&&(e=i);if(e===null)return!1;if(this.len()>1){let i=this.heap.pop();return i.value!=t&&(this.heap[e]=i,this.updateDown(e)),!0}else this.heap.pop();return!0}parentNode(t){return Math.floor((t-1)/2)}leftChildNode(t){return 2*t+1}rightChildNode(t){return 2*t+2}existNode(t){return t>=0&&t<this.heap.length}swap(t,e){const i=this.heap[t];this.heap[t]=this.heap[e],this.heap[e]=i}minNode(t){const e=t.filter(this.existNode.bind(this));let i=e[0];for(const n of e)this.lessThan(this.heap[n],this.heap[i])&&(i=n);return i}updateUp(t){if(t==0)return;const e=this.parentNode(t);this.existNode(e)&&this.lessThan(this.heap[t],this.heap[e])&&(this.swap(t,e),this.updateUp(e))}updateDown(t){const e=this.leftChildNode(t),i=this.rightChildNode(t);if(!this.existNode(e))return;const n=this.minNode([t,e,i]);n!=t&&(this.swap(t,n),this.updateDown(n))}debugPrint(){console.log(this.heap)}}class ji{constructor(){this._time=0,this._events=new xe}getTime(){return this._time}clear(){return this._events=new xe,this}add(t,e){this._events.push(t,e)}get(){if(!this._events.len())return null;let{key:t,value:e}=this._events.pop();return t>0&&(this._time+=t,this._events.shift(-t)),e}getEventTime(t){const e=this._events.find(t);if(e){const{key:i}=e;return i}}remove(t){return this._events.remove(t)}}class ue{constructor(){this._queue=new ji,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),i=this._repeat.indexOf(t);return i!=-1&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}class Vi extends ue{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return this._current!==null&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,0),super.next()}}class $i extends ue{add(t,e,i){return this._queue.add(t,i!==void 0?i:1/t.getSpeed()),super.add(t,e)}next(){return this._current&&this._repeat.indexOf(this._current)!=-1&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}}class Wi extends ue{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(t,e,i){return this._queue.add(t,i||this._defaultDuration),super.add(t,e)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(t){return t==this._current&&(this._duration=this._defaultDuration),super.remove(t)}next(){return this._current!==null&&this._repeat.indexOf(this._current)!=-1&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(t){return this._current&&(this._duration=t),this}}const qi={Simple:Vi,Speed:$i,Action:Wi};class fe{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let n=[],r,o,a;switch(this._options.topology){case 4:o=1,a=[0,1],r=[C[8][7],C[8][1],C[8][3],C[8][5]];break;case 6:r=C[6],o=1,a=[-1,1];break;case 8:r=C[4],o=2,a=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let l=t+a[0]*i,h=e+a[1]*i;for(let c=0;c<r.length;c++)for(let u=0;u<i*o;u++)n.push([l,h]),l+=r[c][0],h+=r[c][1];return n}}class Gi extends fe{compute(t,e,i,n){if(n(t,e,0,1),!this._lightPasses(t,e))return;let r=[],o,a,l,h,c;for(let u=1;u<=i;u++){let p=this._getCircle(t,e,u),d=360/p.length;for(let f=0;f<p.length;f++)if(l=p[f][0],h=p[f][1],o=d*(f-.5),a=o+d,c=!this._lightPasses(l,h),this._visibleCoords(Math.floor(o),Math.ceil(a),c,r)&&n(l,h,u,1),r.length==2&&r[0]==0&&r[1]==360)return}}_visibleCoords(t,e,i,n){if(t<0){let a=this._visibleCoords(0,e,i,n),l=this._visibleCoords(360+t,360,i,n);return a||l}let r=0;for(;r<n.length&&n[r]<t;)r++;if(r==n.length)return i&&n.push(t,e),!0;let o=0;if(r%2){for(;r<n.length&&n[r]<e;)r++,o++;return o==0?!1:(i&&(o%2?n.splice(r-o,o,e):n.splice(r-o,o)),!0)}else{for(;r<n.length&&n[r]<e;)r++,o++;return t==n[r-o]&&o==1?!1:(i&&(o%2?n.splice(r-o,o,t):n.splice(r-o,o,t,e)),!0)}}}class Hi extends fe{compute(t,e,i,n){if(n(t,e,0,1),!this._lightPasses(t,e))return;let r=[],o,a,l,h,c,u;for(let p=1;p<=i;p++){let d=this._getCircle(t,e,p),f=d.length;for(let _=0;_<f;_++)if(o=d[_][0],a=d[_][1],h=[_?2*_-1:2*f-1,2*f],c=[2*_+1,2*f],l=!this._lightPasses(o,a),u=this._checkVisibility(h,c,l,r),u&&n(o,a,p,u),r.length==2&&r[0][0]==0&&r[1][0]==r[1][1])return}}_checkVisibility(t,e,i,n){if(t[0]>e[0]){let d=this._checkVisibility(t,[t[1],t[1]],i,n),f=this._checkVisibility([0,1],e,i,n);return(d+f)/2}let r=0,o=!1;for(;r<n.length;){let d=n[r],f=d[0]*t[1]-t[0]*d[1];if(f>=0){f==0&&!(r%2)&&(o=!0);break}r++}let a=n.length,l=!1;for(;a--;){let d=n[a],f=e[0]*d[1]-d[0]*e[1];if(f>=0){f==0&&a%2&&(l=!0);break}}let h=!0;if((r==a&&(o||l)||o&&l&&r+1==a&&a%2||r>a&&r%2)&&(h=!1),!h)return 0;let c,u=a-r+1;if(u%2)if(r%2){let d=n[r];c=(e[0]*d[1]-d[0]*e[1])/(d[1]*e[1]),i&&n.splice(r,u,e)}else{let d=n[a];c=(d[0]*t[1]-t[0]*d[1])/(t[1]*d[1]),i&&n.splice(r,u,t)}else if(r%2){let d=n[r],f=n[a];c=(f[0]*d[1]-d[0]*f[1])/(d[1]*f[1]),i&&n.splice(r,u)}else return i&&n.splice(r,u,t,e),1;let p=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]);return c/p}}const K=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];class Ki extends fe{compute(t,e,i,n){n(t,e,0,1);for(let r=0;r<K.length;r++)this._renderOctant(t,e,K[r],i,n)}compute180(t,e,i,n,r){r(t,e,0,1);let o=(n-1+8)%8,a=(n-2+8)%8,l=(n+1+8)%8;this._renderOctant(t,e,K[a],i,r),this._renderOctant(t,e,K[o],i,r),this._renderOctant(t,e,K[n],i,r),this._renderOctant(t,e,K[l],i,r)}compute90(t,e,i,n,r){r(t,e,0,1);let o=(n-1+8)%8;this._renderOctant(t,e,K[n],i,r),this._renderOctant(t,e,K[o],i,r)}_renderOctant(t,e,i,n,r){this._castVisibility(t,e,1,1,0,n+1,i[0],i[1],i[2],i[3],r)}_castVisibility(t,e,i,n,r,o,a,l,h,c,u){if(!(n<r))for(let p=i;p<=o;p++){let d=-p-1,f=-p,_=!1,w=0;for(;d<=0;){d+=1;let m=t+d*a+f*l,b=e+d*h+f*c,S=(d-.5)/(f+.5),M=(d+.5)/(f-.5);if(!(M>n)){if(S<r)break;if(d*d+f*f<o*o&&u(m,b,p,1),!_)!this._lightPasses(m,b)&&p<o&&(_=!0,this._castVisibility(t,e,p+1,n,S,o,a,l,h,c,u),w=M);else{if(!this._lightPasses(m,b)){w=M;continue}_=!1,n=w}}}if(_)break}}}const Qi={DiscreteShadowcasting:Gi,PreciseShadowcasting:Hi,RecursiveShadowcasting:Ki};class Ji{}const Zi=.5*(Math.sqrt(3)-1),pt=(3-Math.sqrt(3))/6;class ts extends Ji{constructor(t=256){super(),this._gradients=[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]];let e=[];for(let i=0;i<t;i++)e.push(i);e=x.shuffle(e),this._perms=[],this._indexes=[];for(let i=0;i<2*t;i++)this._perms.push(e[i%t]),this._indexes.push(this._perms[i]%this._gradients.length)}get(t,e){let i=this._perms,n=this._indexes,r=i.length/2,o=0,a=0,l=0,h,c=(t+e)*Zi,u=Math.floor(t+c),p=Math.floor(e+c),d=(u+p)*pt,f=u-d,_=p-d,w=t-f,m=e-_,b,S;w>m?(b=1,S=0):(b=0,S=1);let M=w-b+pt,y=m-S+pt,T=w-1+2*pt,st=m-1+2*pt,Bt=Kt(u,r),Ut=Kt(p,r),ut=.5-w*w-m*m;if(ut>=0){ut*=ut,h=n[Bt+i[Ut]];let H=this._gradients[h];o=ut*ut*(H[0]*w+H[1]*m)}let ft=.5-M*M-y*y;if(ft>=0){ft*=ft,h=n[Bt+b+i[Ut+S]];let H=this._gradients[h];a=ft*ft*(H[0]*M+H[1]*y)}let dt=.5-T*T-st*st;if(dt>=0){dt*=dt,h=n[Bt+1+i[Ut+1]];let H=this._gradients[h];l=dt*dt*(H[0]*T+H[1]*st)}return 70*(o+a+l)}}let qe=class{constructor(t,e,i,n={}){this._toX=t,this._toY=e,this._passableCallback=i,this._options=Object.assign({topology:8},n),this._dirs=C[this._options.topology],this._options.topology==8&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(t,e){let i=[];for(let n=0;n<this._dirs.length;n++){let r=this._dirs[n],o=t+r[0],a=e+r[1];this._passableCallback(o,a)&&i.push([o,a])}return i}};class es extends qe{constructor(t,e,i,n){super(t,e,i,n),this._computed={},this._todo=[],this._add(t,e,null)}compute(t,e,i){let n=t+","+e;if(n in this._computed||this._compute(t,e),!(n in this._computed))return;let r=this._computed[n];for(;r;)i(r.x,r.y),r=r.prev}_compute(t,e){for(;this._todo.length;){let i=this._todo.shift();if(i.x==t&&i.y==e)return;let n=this._getNeighbors(i.x,i.y);for(let r=0;r<n.length;r++){let o=n[r],a=o[0],l=o[1];a+","+l in this._computed||this._add(a,l,i)}}}_add(t,e,i){let n={x:t,y:e,prev:i};this._computed[t+","+e]=n,this._todo.push(n)}}class is extends qe{constructor(t,e,i,n={}){super(t,e,i,n),this._todo=[],this._done={}}compute(t,e,i){for(this._todo=[],this._done={},this._fromX=t,this._fromY=e,this._add(this._toX,this._toY,null);this._todo.length;){let r=this._todo.shift(),o=r.x+","+r.y;if(o in this._done)continue;if(this._done[o]=r,r.x==t&&r.y==e)break;let a=this._getNeighbors(r.x,r.y);for(let l=0;l<a.length;l++){let h=a[l],c=h[0],u=h[1];c+","+u in this._done||this._add(c,u,r)}}let n=this._done[t+","+e];if(n)for(;n;)i(n.x,n.y),n=n.prev}_add(t,e,i){let n=this._distance(t,e),r={x:t,y:e,prev:i,g:i?i.g+1:0,h:n},o=r.g+r.h;for(let a=0;a<this._todo.length;a++){let l=this._todo[a],h=l.g+l.h;if(o<h||o==h&&n<l.h){this._todo.splice(a,0,r);return}}this._todo.push(r)}_distance(t,e){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(e-this._fromY);case 6:let i=Math.abs(t-this._fromX),n=Math.abs(e-this._fromY);return n+Math.max(0,(i-n)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(e-this._fromY))}}}const Ge={Dijkstra:es,AStar:is},Y=Ti;class Yt{constructor(t,e=0){this.bounds={x:t.x||0,y:t.y||0,width:t.width,height:t.height},this.maxObjects=typeof t.maxObjects=="number"?t.maxObjects:10,this.maxLevels=typeof t.maxLevels=="number"?t.maxLevels:4,this.level=e,this.objects=[],this.nodes=[]}getIndex(t){return t.qtIndex(this.bounds)}split(){const t=this.level+1,e=this.bounds.width/2,i=this.bounds.height/2,n=this.bounds.x,r=this.bounds.y,o=[{x:n+e,y:r},{x:n,y:r},{x:n,y:r+i},{x:n+e,y:r+i}];for(let a=0;a<4;a++)this.nodes[a]=new Yt({x:o[a].x,y:o[a].y,width:e,height:i,maxObjects:this.maxObjects,maxLevels:this.maxLevels},t)}insert(t){if(this.nodes.length){const e=this.getIndex(t);for(let i=0;i<e.length;i++)this.nodes[e[i]].insert(t);return}if(this.objects.push(t),this.objects.length>this.maxObjects&&this.level<this.maxLevels){this.nodes.length||this.split();for(let e=0;e<this.objects.length;e++){const i=this.getIndex(this.objects[e]);for(let n=0;n<i.length;n++)this.nodes[i[n]].insert(this.objects[e])}this.objects=[]}}retrieve(t){const e=this.getIndex(t);let i=this.objects;if(this.nodes.length)for(let n=0;n<e.length;n++)i=i.concat(this.nodes[e[n]].retrieve(t));return this.level===0?Array.from(new Set(i)):i}remove(t,e=!1){const i=this.objects.indexOf(t);i>-1&&this.objects.splice(i,1);for(let n=0;n<this.nodes.length;n++)this.nodes[n].remove(t);return this.level===0&&!e&&this.join(),i!==-1}update(t,e=!1){this.remove(t,e),this.insert(t)}join(){let t=Array.from(this.objects);for(let i=0;i<this.nodes.length;i++){const n=this.nodes[i].join();t=t.concat(n)}const e=Array.from(new Set(t));if(e.length<=this.maxObjects){this.objects=e;for(let i=0;i<this.nodes.length;i++)this.nodes[i].objects=[];this.nodes=[]}return t}clear(){this.objects=[];for(let t=0;t<this.nodes.length;t++)this.nodes.length&&this.nodes[t].clear();this.nodes=[]}}class He{constructor(t){this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.data=t.data}qtIndex(t){const e=[],i=t.x+t.width/2,n=t.y+t.height/2,r=this.y<n,o=this.x<i,a=this.x+this.width>i,l=this.y+this.height>n;return r&&a&&e.push(0),o&&r&&e.push(1),o&&l&&e.push(2),a&&l&&e.push(3),e}}class At{constructor(t){this.x=t.x,this.y=t.y,this.r=t.r,this.data=t.data}qtIndex(t){const e=[],i=t.width/2,n=t.height/2,r=t.x+i,o=t.y+n,a=[[r,t.y],[t.x,t.y],[t.x,o],[r,o]];for(let l=0;l<a.length;l++)At.intersectRect(this.x,this.y,this.r,a[l][0],a[l][1],a[l][0]+i,a[l][1]+n)&&e.push(l);return e}static intersectRect(t,e,i,n,r,o,a){const l=t-Math.max(n,Math.min(t,o)),h=e-Math.max(r,Math.min(e,a));return l*l+h*h<i*i}}class de{constructor(t,e,i={ch:"!",fg:"red"}){g(this,"_visual");g(this,"_xy");g(this,"_level");this._level=t,this._xy=e,this._visual=i}qtIndex(t){return At.prototype.qtIndex.call({x:this.getXY().x,y:this.getXY().y,r:1},t)}setVisual(t){this._visual={...this._visual,...t}}getVisual(){return this._visual}getXY(){return this._xy}getLevel(){return this._level}setPosition(t){return this._xy=t,this}remove(){}onInteract(t){return!0}}class v{constructor(t=0,e=0){g(this,"x");g(this,"y");this.x=t,this.y=e}toString(){return this.x+","+this.y}is(t){return this.x==t.x&&this.y==t.y}dist8(t){let e=t.x-this.x,i=t.y-this.y;return Math.max(Math.abs(e),Math.abs(i))}dist4(t){let e=t.x-this.x,i=t.y-this.y;return Math.abs(e)+Math.abs(i)}dist(t){let e=t.x-this.x,i=t.y-this.y;return Math.sqrt(e*e+i*i)}plus(t){return new v(this.x+t.x,this.y+t.y)}minus(t){return new v(this.x-t.x,this.y-t.y)}div(t){return new v(this.x/t,this.y/t)}}class ss{constructor(t){g(this,"showing");g(this,"_data");g(this,"_multiText");g(this,"displayBoxPos");g(this,"displayBoxSize");g(this,"_options");g(this,"_cb");g(this,"game");this.showing=!1,this._data=[],this._options={display:t.display,position:new v,size:new v},this.displayBoxPos=new v(10,5),this.displayBoxSize=new v(90,25),this._cb=null,this.game=t}configure(t){Object.assign(this._options,t)}clear(){this._data=[]}write(t,e=!1){!e&&this.clear(),this._data.push(t),!e&&this.flush()}flush(){let t=this._options,e=t.display,i=t.position,n=t.size;for(let o=0;o<n.x;o++)for(let a=0;a<n.y;a++)e.draw(i.x+o,i.y+a);let r=this._data.join(" ");e.drawText(i.x,i.y,r,n.x)}displayBox(t,e=null){this._multiText=t.split("---"),this._cb=e,this._renderDisplayBox(this._multiText.shift())}_renderDisplayBox(t){this.showing=!0;let i=this._options.display,n=this.displayBoxPos,r=this.displayBoxSize;for(let h=0;h<r.x;h++)for(let c=0;c<r.y;c++)if(h===0||h===r.x-1||c===0||c===r.y-1){let u=h===0||h===r.x-1?"+":"=";i.draw(n.x+h,n.y+c,u)}else i.draw(n.x+h,n.y+c," ");let o=5,a=n.x+o,l=n.y+o;i.drawText(a,l,t,r.x-o*2),i.drawText(a,n.y+r.y-3,"Press [Enter] to continue",r.x-o*2)}clearDisplayBox(){this.showing=!1;let e=this._options.display,i=this.displayBoxPos,n=this.displayBoxSize,r=new v;for(let a=0;a<n.x;a++)for(let l=0;l<n.y;l++)r.x=i.x+a,r.y=i.y+l,e.draw(r.x,r.y," "),this.game.level.draw(r);let o=this._multiText.shift();if(o){this._renderDisplayBox(o);return}this._cb&&(this._cb(),this._cb=null),this.game.level.updateFOV()}}class J extends de{constructor(){super(...arguments);g(this,"id",0);g(this,"terrain",!0)}}class k extends J{constructor(t,e){let i=x.getItem(["#e11","#e43"]);super(t,e,{ch:"༉",fg:i})}}class L extends J{constructor(t,e){super(t,e),this.setVisual(this.getRandomVisual())}getRandomVisual(){let t=x.getItem("≋≈".split("")),e=x.getItem(["#44f","#66e"]);return{ch:t,fg:e}}flow(){this.setVisual(this.getRandomVisual())}}class kt extends J{constructor(t,e){super(t,e),this.setVisual(this.getRandomVisual())}getRandomVisual(){let t=x.getItem("༄༅".split("")),e=x.getItem(["#11d","#11a"]);return{ch:t,fg:e}}flow(){this.setVisual(this.getRandomVisual())}}class lt extends J{constructor(t,e){let i=x.getItem("¸ʾ˚˓");super(t,e,{ch:i,fg:"#754"})}}class nt extends J{constructor(t,e){let i=x.getItem("ɷɞɜ");super(t,e,{ch:i,fg:"#2a2"})}}class Ct extends J{constructor(t,e){let i=x.getItem("ɰɱɵɛ");super(t,e,{ch:i,fg:"#172"})}}class Wt extends J{constructor(t,e){let i=x.getItem("ƍʕʔʃʆψβϡ");super(t,e,{ch:i,fg:"#050"})}}class pe{constructor(t,e){g(this,"size");g(this,"_map");g(this,"_indexed",new Map);g(this,"_ids");this._ids=new Map,this.size=new v(t,e),this._map=Array.from(Array(t),()=>Array(e).fill(null))}getById(t){return this._ids.get(t)}set(t,e=!1){if(!(t instanceof J))throw new Error("Only instances of Terrain allowed in World map, got "+t.constructor.name);this.checkBounds(t.getXY());let{x:i,y:n}=t.getXY();if(this._map[i][n]=t,this._ids.set(t.id,t),e){let r=t.constructor;this._indexed.has(r)||this._indexed.set(r,new Set),this._indexed.get(r).add(t)}}remove(t){let{x:e,y:i}=t.getXY();this._map[e][i]=null,this.removeFromIndex(t),this._ids.delete(t.id)}removeFromIndex(t){var i;let e=t.constructor;(i=this._indexed.get(e))==null||i.delete(t)}at(t,e){let i=typeof t=="number"&&typeof e=="number"?new v(t,e):t;return this.checkBounds(i),this._map[i.x][i.y]}get(t=null){return t||(t={x:0,y:0,w:this.size.x,h:this.size.y}),this._map.slice(t.x,t.x+t.w).flatMap(e=>e.slice(t.y,t.y+t.h)).filter(e=>e!==null)}nearest(t){return[]}getTagged(t){return this._indexed.get(t)||new Set}checkBounds({x:t,y:e}){if(t<0||e<0||t>=this.size.x||e>=this.size.y)throw`Terrain position (${t}, ${e}) is out of bounds`}}const ns=`▄▄▄█████▓ ██░ ██  █    ██  ███▄    █ ▓█████▄ ▓█████  ██▀███   
▓  ██▒ ▓▒▓██░ ██▒ ██  ▓██▒ ██ ▀█   █ ▒██▀ ██▌▓█   ▀ ▓██ ▒ ██▒ 
▒ ▓██░ ▒░▒██▀▀██░▓██  ▒██░▓██  ▀█ ██▒░██   █▌▒███   ▓██ ░▄█ ▒ 
░ ▓██▓ ░ ░▓█ ░██ ▓▓█  ░██░▓██▒  ▐▌██▒░▓█▄   ▌▒▓█  ▄ ▒██▀▀█▄   
  ▒██▒ ░ ░▓█▒░██▓▒▒█████▓ ▒██░   ▓██░░▒████▓ ░▒████▒░██▓ ▒██▒ 
  ▒ ░░    ▒ ░░▒░▒░▒▓▒ ▒ ▒ ░ ▒░   ▒ ▒  ▒▒▓  ▒ ░░ ▒░ ░░ ▒▓ ░▒▓░ 
    ░     ▒ ░▒░ ░░░▒░ ░ ░ ░ ░░   ░ ▒░ ░ ▒  ▒  ░ ░  ░  ░▒ ░ ▒░ 
  ░       ░  ░░ ░ ░░░ ░ ░    ░   ░ ░  ░ ░  ░    ░     ░░   ░  
          ░  ░  ░   ░              ░    ░       ░  ░   ░      
                                      ░                       


        ██▓     ██▓▒███████▒ ▄▄▄       ██▀███  ▓█████▄ 
       ▓██▒    ▓██▒▒ ▒ ▒ ▄▀░▒████▄    ▓██ ▒ ██▒▒██▀ ██▌
       ▒██░    ▒██▒░ ▒ ▄▀▒░ ▒██  ▀█▄  ▓██ ░▄█ ▒░██   █▌
       ▒██░    ░██░  ▄▀▒   ░░██▄▄▄▄██ ▒██▀▀█▄  ░▓█▄   ▌
       ░██████▒░██░▒███████▒ ▓█   ▓██▒░██▓ ▒██▒░▒████▓ 
       ░ ▒░▓  ░░▓  ░▒▒ ▓░▒░▒ ▒▒   ▓▒█░░ ▒▓ ░▒▓░ ▒▒▓  ▒ 
       ░ ░ ▒  ░ ▒ ░░░▒ ▒ ░ ▒  ▒   ▒▒ ░  ░▒ ░ ▒░ ░ ▒  ▒ 
         ░ ░    ▒ ░░ ░ ░ ░ ░  ░   ▒     ░░   ░  ░ ░  ░ 
           ░  ░ ░    ░ ░          ░  ░   ░        ░    
                   ░                            ░      
     

   
                        Eat or be eaten.
   
                    Press any key to hatch...                                        
                                                                                                              


`,[Se,Ee]=[80,55];class Ke{constructor(t){g(this,"size",new v(Se,Ee));g(this,"game");g(this,"bgMap",new pe(Se,Ee));g(this,"_levelData",ns);g(this,"_interval",0);this.game=t,this._generateBG(),this._drawMap(),this._lavaloop()}draw(t){this._drawMap()}onClick(t){this.onKeyDown(new KeyboardEvent("keydown",{key:"Enter"}))}onKeyDown(t){clearInterval(this._interval),this.game.switchLevel(new be(this.game))}getSize(){return this.size}_clear(){for(let t=0;t<this.size.y;t++)for(let e=0;e<this.size.x;e++)this.game.display.draw(e,t," ",null,null)}_lavaloop(){const e=()=>{for(let i of[...this.bgMap.getTagged(k)]){let{x:n,y:r}=i.getXY();if(n===0||r===0||n===this.size.x-1||r===this.size.y-1)continue;let o=this.bgMap.at(n,r-1),a=this.bgMap.at(n,r+1),l=this.bgMap.at(n-1,r),h=this.bgMap.at(n+1,r),c=new Set([o,a,l,h].filter(u=>u));for(let u of c){if(!(u instanceof lt)){c.delete(u);continue}if(x.getPercentage()<=10){let p=new k(this,u.getXY());this.bgMap.set(p,!0),this.bgMap.removeFromIndex(u)}}if(c.size===0){this.bgMap.removeFromIndex(i);let u=x.getItem("¸ʾ˚˓".split(""));i.setVisual({ch:u})}}this._drawMap(),this._interval=setTimeout(e,300)};e()}_generateBG(){let t=[100,80,50,10,0];for(let e=0;e<this.size.y;e++)for(let i=0;i<this.size.x;i++)(e===0||this.bgMap.at(i,e-1)instanceof k)&&x.getPercentage()<=(t[e]||0)?this.bgMap.set(new k(this.game.level,new v(i,e)),!0):this.bgMap.set(new lt(this.game.level,new v(i,e)),!0)}_drawMap(){let t=this._levelData.split(`
`),e=Math.ceil((this.size.x-t[0].length)/2),i=13;for(let n=0;n<this.size.y;n++)for(let r=0;r<this.size.x;r++){let o=this.bgMap.at(r,n),a=o.getVisual().ch,l=o.getVisual().fg,h=n-i,c=r-e;t[h]&&t[h][c]&&t[h][c]!=" "&&(a=t[h][c],l="orange"),this.game.display.draw(r,n,a,l)}}}const[Me,Te]=[80,55];class rs{constructor(t){g(this,"size",new v(Me,Te));g(this,"game");g(this,"bgMap",new pe(Me,Te));g(this,"_interval",0);this.game=t,this._generateBG(),this._drawMap(),this._lavaloop()}draw(t){this._drawMap()}onClick(t){this.onKeyDown(new KeyboardEvent("keydown",{key:"Enter"}))}onKeyDown(t){clearInterval(this._interval),t.key==="Enter"||t.key===" "?this.game.switchLevel(new be(this.game)):t.key==="Escape"&&this.game.switchLevel(new Ke(this.game))}getSize(){return this.size}_clear(){for(let t=0;t<this.size.y;t++)for(let e=0;e<this.size.x;e++)this.game.display.draw(e,t," ",null,null)}_lavaloop(){const e=()=>{for(let i of[...this.bgMap.getTagged(k)]){let{x:n,y:r}=i.getXY();if(n===0||r===0||n===this.size.x-1||r===this.size.y-1)continue;let o=this.bgMap.at(n,r-1),a=this.bgMap.at(n,r+1),l=this.bgMap.at(n-1,r),h=this.bgMap.at(n+1,r),c=new Set([o,a,l,h].filter(u=>u));for(let u of c){if(!(u instanceof lt)){c.delete(u);continue}if(x.getPercentage()<=10){let p=new k(this,u.getXY());this.bgMap.set(p,!0),this.bgMap.removeFromIndex(u)}}if(c.size===0){this.bgMap.removeFromIndex(i);let u=x.getItem("¸ʾ˚˓".split(""));i.setVisual({ch:u})}}this._drawMap(),this._interval=setTimeout(e,300)};e()}_generateBG(){let t=[100,80,50,10,0];for(let e=0;e<this.size.y;e++)for(let i=0;i<this.size.x;i++)(e===0||this.bgMap.at(i,e-1)instanceof k)&&x.getPercentage()<=(t[e]||0)?this.bgMap.set(new k(this,new v(i,e)),!0):this.bgMap.set(new lt(this,new v(i,e)),!0)}_drawMap(){const t=["YOU DIED","","The mighty thunder lizard","has fallen...","","Press ENTER to try again","Press ESCAPE for main menu"];let e=Math.ceil((this.size.x-t[0].length)/2),i=Math.ceil((this.size.y-t.length)/2);for(let n=0;n<this.size.y;n++)for(let r=0;r<this.size.x;r++){let o=this.bgMap.at(r,n),a=o.getVisual().ch,l=o.getVisual().fg,h=n-i,c=r-e;t[h]&&t[h][c]&&t[h][c]!=" "&&(a=t[h][c],l="red"),this.game.display.draw(r,n,a,l)}}}var rt={i8:"i8",ui8:"ui8",ui8c:"ui8c",i16:"i16",ui16:"ui16",i32:"i32",ui32:"ui32",f32:"f32",f64:"f64",eid:"eid"},Ce={i8:"Int8",ui8:"Uint8",ui8c:"Uint8Clamped",i16:"Int16",ui16:"Uint16",i32:"Int32",ui32:"Uint32",eid:"Uint32",f32:"Float32",f64:"Float64"},Z={i8:Int8Array,ui8:Uint8Array,ui8c:Uint8ClampedArray,i16:Int16Array,ui16:Uint16Array,i32:Int32Array,ui32:Uint32Array,f32:Float32Array,f64:Float64Array,eid:Uint32Array},Pe={uint8:2**8,uint16:2**16,uint32:2**32},os=s=>t=>Math.ceil(t/s)*s,as=os(4),ls=Symbol("storeRef"),Zt=Symbol("storeSize"),hs=Symbol("storeMaps"),et=Symbol("storeFlattened"),Pt=Symbol("storeBase"),cs=Symbol("storeType"),Qe=Symbol("storeArrayElementCounts"),zt=Symbol("storeSubarrays"),Je=Symbol("subarrayCursors"),us=Symbol("subarray"),te=Symbol("parentArray"),Ze=Symbol("tagStore"),Oe=Symbol("indexType"),ke=Symbol("indexBytes"),ti=Symbol("isEidType"),j={},fs=(s,t)=>{if(ArrayBuffer.isView(s))s[t]=s.slice(0);else{const e=s[te].slice(0);s[t]=s.map((i,n)=>{const{length:r}=s[n],o=r*n,a=o+r;return e.subarray(o,a)})}},ei=(s,t)=>{s[et]&&s[et].forEach(e=>{ArrayBuffer.isView(e)?e[t]=0:e[t].fill(0)})},ds=(s,t)=>{const e=t*Z[s].BYTES_PER_ELEMENT,i=new ArrayBuffer(e),n=new Z[s](i);return n[ti]=s===rt.eid,n},ps=(s,t,e)=>{const i=s[Zt],n=Array(i).fill(0);n[cs]=t,n[ti]=t===rt.eid;const r=s[Je],o=e<=Pe.uint8?rt.ui8:e<=Pe.uint16?rt.ui16:rt.ui32;if(!e)throw new Error("bitECS - Must define component array length");if(!Z[t])throw new Error(`bitECS - Invalid component array property type ${t}`);if(!s[zt][t]){const h=s[Qe][t],c=new Z[t](as(h*i));c[Oe]=Ce[o],c[ke]=Z[o].BYTES_PER_ELEMENT,s[zt][t]=c}const a=r[t],l=a+i*e;r[t]=l,n[te]=s[zt][t].subarray(a,l);for(let h=0;h<i;h++){const c=e*h,u=c+e;n[h]=n[te].subarray(c,u),n[h][Oe]=Ce[o],n[h][ke]=Z[o].BYTES_PER_ELEMENT,n[h][us]=!0}return n},ze=s=>Array.isArray(s)&&typeof s[0]=="string"&&typeof s[1]=="number",gs=(s,t)=>{const e=Symbol("store");if(!s||!Object.keys(s).length)return j[e]={[Zt]:t,[Ze]:!0,[Pt]:()=>j[e]},j[e];s=JSON.parse(JSON.stringify(s));const i={},n=o=>{const a=Object.keys(o);for(const l of a)ze(o[l])?(i[o[l][0]]||(i[o[l][0]]=0),i[o[l][0]]+=o[l][1]):o[l]instanceof Object&&n(o[l])};n(s);const r={[Zt]:t,[hs]:{},[zt]:{},[ls]:e,[Je]:Object.keys(Z).reduce((o,a)=>({...o,[a]:0}),{}),[et]:[],[Qe]:i};if(s instanceof Object&&Object.keys(s).length){const o=(a,l)=>{if(typeof a[l]=="string")a[l]=ds(a[l],t),a[l][Pt]=()=>j[e],r[et].push(a[l]);else if(ze(a[l])){const[h,c]=a[l];a[l]=ps(r,h,c),a[l][Pt]=()=>j[e],r[et].push(a[l])}else a[l]instanceof Object&&(a[l]=Object.keys(a[l]).reduce(o,a[l]));return a};return j[e]=Object.assign(Object.keys(s).reduce(o,s),r),j[e][Pt]=()=>j[e],j[e]}},mt=()=>{const s=[],t=[];s.sort=function(o){const a=Array.prototype.sort.call(this,o);for(let l=0;l<s.length;l++)t[s[l]]=l;return a};const e=o=>s[t[o]]===o;return{add:o=>{e(o)||(t[o]=s.push(o)-1)},remove:o=>{if(!e(o))return;const a=t[o],l=s.pop();l!==o&&(s[a]=l,t[l]=a)},has:e,sparse:t,dense:s,reset:()=>{s.length=0,t.length=0}}},q=Symbol("entityMasks"),ct=Symbol("entityComponents"),G=Symbol("entitySparseSet"),vt=Symbol("entityArray"),ms=1e5,ee=0,ii=ms,ge=()=>ii,_t=[],_s=.01,ys=_s,vs=()=>ee,ws=new Map,qt=s=>{const t=s[ve]?_t.length?_t.shift():ee++:_t.length>Math.round(ii*ys)?_t.shift():ee++;if(t>s[ye])throw new Error("bitECS - max entities reached");return s[G].add(t),ws.set(t,s),s[me].forEach(e=>{Dt(s,e,t)&&Nt(e,t)}),s[ct].set(t,new Set),t},bs=(s,t)=>{if(s[G].has(t)){s[Ft].forEach(e=>{_e(s,e,t)}),s[ve]||_t.push(t),s[G].remove(t),s[ct].delete(t),s[ri].delete(s[ne].get(t)),s[ne].delete(t);for(let e=0;e<s[q].length;e++)s[q][e][t]=0}},Ie=(s,t)=>{if(t===void 0)throw new Error("bitECS - entity is undefined.");if(!s[G].has(t))throw new Error("bitECS - entity does not exist in the world.");return Array.from(s[ct].get(t))},si=Symbol("$modifier");function xs(s,t){const e=()=>[s,t];return e[si]=!0,e}var ie=s=>xs(s,"not"),Ft=Symbol("queries"),me=Symbol("notQueries"),Ss=Symbol("queryAny"),Es=Symbol("queryAll"),Ms=Symbol("queryNone"),Rt=Symbol("queryMap"),wt=Symbol("$dirtyQueries"),ni=Symbol("queryComponents"),Ts=(s,t)=>{const e=[],i=[],n=[];t[ni].forEach(y=>{if(typeof y=="function"&&y[si]){const[T,st]=y();s[U].has(T)||se(s,T),st==="not"&&i.push(T),st==="changed"&&(n.push(T),e.push(T))}else s[U].has(y)||se(s,y),e.push(y)});const r=y=>s[U].get(y),o=e.concat(i).map(r),a=mt(),l=[],h=[],c=mt(),u=mt(),p=mt(),d=o.map(y=>y.generationId).reduce((y,T)=>(y.includes(T)||y.push(T),y),[]),f=(y,T)=>(y[T.generationId]||(y[T.generationId]=0),y[T.generationId]|=T.bitflag,y),_=e.map(r).reduce(f,{}),w=i.map(r).reduce(f,{}),m=o.reduce(f,{}),b=e.filter(y=>!y[Ze]).map(y=>Object.getOwnPropertySymbols(y).includes(et)?y[et]:[y]).reduce((y,T)=>y.concat(T),[]),M=Object.assign(a,{archetypes:l,changed:h,components:e,notComponents:i,changedComponents:n,allComponents:o,masks:_,notMasks:w,hasMasks:m,generations:d,flatProps:b,toRemove:c,entered:u,exited:p,shadows:[]});s[Rt].set(t,M),s[Ft].add(M),o.forEach(y=>{y.queries.add(M)}),i.length&&s[me].add(M);for(let y=0;y<vs();y++){if(!s[G].has(y))continue;Dt(s,M,y)&&Nt(M,y)}},Cs=(s,t)=>{const e=Symbol(),i=s.flatProps[t];return fs(i,e),s.shadows[t]=i[e],i[e]},Ps=(s,t)=>{t&&(s.changed=[]);const{flatProps:e,shadows:i}=s;for(let n=0;n<s.dense.length;n++){const r=s.dense[n];let o=!1;for(let a=0;a<e.length;a++){const l=e[a],h=i[a]||Cs(s,a);if(ArrayBuffer.isView(l[r])){for(let c=0;c<l[r].length;c++)if(l[r][c]!==h[r][c]){o=!0;break}h[r].set(l[r])}else l[r]!==h[r]&&(o=!0,h[r]=l[r])}o&&s.changed.push(r)}return s.changed},ot=(...s)=>{let t,e,i,n;if(Array.isArray(s[0])&&(t=s[0]),t===void 0||t[U]!==void 0)return o=>o?o[vt]:t[vt];const r=function(o,a=!0){o[Rt].has(r)||Ts(o,r);const l=o[Rt].get(r);return ks(o),l.changedComponents.length?Ps(l,a):l.dense};return r[ni]=t,r[Ss]=e,r[Es]=i,r[Ms]=n,r},Dt=(s,t,e)=>{const{masks:i,notMasks:n,generations:r}=t;for(let o=0;o<r.length;o++){const a=r[o],l=i[a],h=n[a],c=s[q][a][e];if(h&&c&h||l&&(c&l)!==l)return!1}return!0},Nt=(s,t)=>{s.toRemove.remove(t),s.entered.add(t),s.add(t)},Os=s=>{for(let t=s.toRemove.dense.length-1;t>=0;t--){const e=s.toRemove.dense[t];s.toRemove.remove(e),s.remove(e)}},ks=s=>{s[wt].size&&(s[wt].forEach(Os),s[wt].clear())},_e=(s,t,e)=>{!t.has(e)||t.toRemove.has(e)||(t.toRemove.add(e),s[wt].add(t),t.exited.add(e))},U=Symbol("componentMap"),N=(s,t)=>{const e=gs(s,ge());return s&&Object.keys(s).length,e},zs=s=>{s[bt]*=2,s[bt]>=2**31&&(s[bt]=1,s[q].push(new Uint32Array(s[ye])))},se=(s,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");const e=new Set,i=new Set,n=new Set;s[Ft].forEach(r=>{r.allComponents.includes(t)&&e.add(r)}),s[U].set(t,{generationId:s[q].length-1,bitflag:s[bt],store:t,queries:e,notQueries:i,changedQueries:n}),zs(s)},D=(s,t,e)=>{const i=s[U].get(t);if(!i)return!1;const{generationId:n,bitflag:r}=i;return(s[q][n][e]&r)===r},R=(s,t,e,i=!1)=>{if(e===void 0)throw new Error("bitECS - entity is undefined.");if(!s[G].has(e))throw new Error("bitECS - entity does not exist in the world.");if(s[U].has(t)||se(s,t),D(s,t,e))return;const n=s[U].get(t),{generationId:r,bitflag:o,queries:a,notQueries:l}=n;s[q][r][e]|=o,a.forEach(h=>{h.toRemove.remove(e);const c=Dt(s,h,e);c&&(h.exited.remove(e),Nt(h,e)),c||(h.entered.remove(e),_e(s,h,e))}),s[ct].get(e).add(t),i&&ei(t,e)},F=(s,t,e,i=!0)=>{if(e===void 0)throw new Error("bitECS - entity is undefined.");if(!s[G].has(e))throw new Error("bitECS - entity does not exist in the world.");if(!D(s,t,e))return;const n=s[U].get(t),{generationId:r,bitflag:o,queries:a}=n;s[q][r][e]&=~o,a.forEach(l=>{l.toRemove.remove(e);const h=Dt(s,l,e);h&&(l.exited.remove(e),Nt(l,e)),h||(l.entered.remove(e),_e(s,l,e))}),s[ct].get(e).delete(t),i&&ei(t,e)},ye=Symbol("size"),bt=Symbol("bitflag"),Is=Symbol("archetypes"),ri=Symbol("localEntities"),ne=Symbol("localEntityLookup"),ve=Symbol("manualEntityRecycling"),Re=(...s)=>{const t=typeof s[0]=="object"?s[0]:{},e=typeof s[0]=="number"?s[0]:typeof s[1]=="number"?s[1]:ge();return Rs(t,e),t},Rs=(s,t=ge())=>(s[ye]=t,s[vt]&&s[vt].forEach(e=>bs(s,e)),s[q]=[new Uint32Array(t)],s[ct]=new Map,s[Is]=[],s[G]=mt(),s[vt]=s[G].dense,s[bt]=1,s[U]=new Map,s[Rt]=new Map,s[Ft]=new Set,s[me]=new Set,s[wt]=new Set,s[ri]=new Map,s[ne]=new Map,s[ve]=!1,s),P=rt,Lt=function(){return Lt=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++){e=arguments[i];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])}return t},Lt.apply(this,arguments)},Ls={meter:!0,side:"bottom-right",FPS:60,tolerance:1,meterWidth:100,meterHeight:25,meterLineHeight:4,styles:{background:"rgba(0, 0, 0, 0.5)",color:"white"},stylesFPS:{padding:"0.1em 0.5em"},text:" FPS",colorGreen:"#00ff00",colorOrange:"#ffa500",colorRed:"#ff0000",zIndex:1e3},Xs=function(){function s(t){t===void 0&&(t={}),this.lastTime=0,this.frameNumber=0,this.lastFPS=0,this.options=Lt(Lt({},Ls),t),this.div=document.createElement("div"),this.findParent(this.options.side||"bottom-right").appendChild(this.div),this.style(this.div,this.options.styles),this.createDivFPS(),this.options.meter&&this.createDivMeter()}return Object.defineProperty(s.prototype,"fps",{get:function(){return this.options.FPS},set:function(t){this.options.FPS=t},enumerable:!1,configurable:!0}),s.prototype.remove=function(){this.div.remove()},Object.defineProperty(s.prototype,"meter",{get:function(){return this.options.meter},set:function(t){t?this.createDivMeter():this.meterCanvas&&(this.meterCanvas.style.display="none")},enumerable:!1,configurable:!0}),s.prototype.style=function(t,e){for(var i in e)t.style[i]=e[i]},s.prototype.createDivFPS=function(){var t=document.createElement("div");this.style(t,this.options.stylesFPS),this.div.appendChild(t),this.fpsSpan=document.createElement("span"),t.appendChild(this.fpsSpan);var e=document.createElement("span");t.appendChild(e),e.innerText=this.options.text},s.prototype.createDivMeter=function(){this.meterCanvas?this.meterCanvas.style.display="block":(this.meterCanvas=document.createElement("canvas"),this.div.appendChild(this.meterCanvas),this.meterCanvas.width=this.options.meterWidth,this.meterCanvas.height=this.options.meterHeight,this.meterCanvas.style.width=this.options.meterWidth+"px",this.meterCanvas.style.height=this.options.meterHeight+"px",this.style(this.meterCanvas,this.options.stylesMeter),this.meterContext=this.meterCanvas.getContext("2d",{willReadFrequently:!0}))},s.prototype.frame=function(){this.frameNumber++;var t=performance.now()-this.lastTime;t>500&&(this.lastTime!==0&&(this.lastFPS=Math.floor(this.frameNumber/(t/1e3)),(this.lastFPS>this.options.FPS||this.lastFPS>=this.options.FPS-this.options.tolerance&&this.lastFPS<=this.options.FPS+this.options.tolerance)&&(this.lastFPS=this.options.FPS)),this.lastTime=performance.now(),this.frameNumber=0),this.fpsSpan.innerText=this.lastFPS===0?"--":this.lastFPS+"",this.options.meter&&this.lastFPS!==0&&this.meterUpdate(this.lastFPS/this.options.FPS)},s.prototype.mix=function(t,e,i){var n=function(u){return{r:parseInt(u.substr(1,2),16),g:parseInt(u.substr(3,2),16),b:parseInt(u.substr(5,2),16)}},r=function(u){return u=Math.floor(u),u.toString().length===1?"0"+u.toString(16):u.toString(16)},o=n(t),a=n(e),l=r(o.r*i+a.r*(1-i)),h=r(o.g*i+a.g*(1-i)),c=r(o.b*i+a.b*(1-i));return"#".concat(l).concat(h).concat(c)},s.prototype.meterUpdate=function(t){var e=this.meterContext.getImageData(0,0,this.meterCanvas.width,this.meterCanvas.height);this.meterContext.putImageData(e,-1,0),this.meterContext.clearRect(this.meterCanvas.width-1,0,1,this.meterCanvas.height),t<=.5?this.meterContext.fillStyle=this.mix(this.options.colorRed,this.options.colorOrange,1-t*2):this.meterContext.fillStyle=this.mix(this.options.colorGreen,this.options.colorOrange,(t-.5)*2);var i=(this.meterCanvas.height-this.options.meterLineHeight)*(1-t);this.meterContext.fillRect(this.meterCanvas.width-1,i,1,this.options.meterLineHeight)},s.prototype.findParent=function(t){var e=[],i="yy-counter-";t.indexOf("left")!==-1?(i+="left-",e.left=0):(i+="right-",e.right=0),t.indexOf("top")!==-1?(i+="top",e.top=0):(i+="bottom",e.bottom=0);var n=document.getElementById(i);if(n)return n;var r=document.createElement("div");r.id=i,r.style.overflow="hidden",r.style.position="fixed",r.style.zIndex=this.options.zIndex.toString(),r.style.pointerEvents="none",r.style.userSelect="none";for(var o in e)r.style[o]=e[o];return document.body.appendChild(r),r},s}();function Ys(s){const t=new Xs({meter:!0,stylesFPS:{fontSize:"10px"},meterLineHeight:1});function e(){t.frame(),requestAnimationFrame(e)}e(),window.dinos=s.dinos,window._at=(i,n)=>s.map.at(new v(i,n)),s.game._container.addEventListener("click",i=>{let n=new v(...s.game.display.eventToPosition(i)).plus(s.viewportOffset),r=s.map.at(n),o=s.dinos.at(n);o?console.log(o,Ie(s.dinoEcsWorld,o.id).reduce((a,l)=>(a.push(Object.entries(l).flatMap(([h,c])=>`${h}: ${c[o.id]}`).join(", ")),a),[])):r&&console.log(r,Ie(s.terrainEcsWorld,r.id).reduce((a,l)=>(a.push(Object.entries(l).flatMap(([h,c])=>`${h}: ${c[r.id]}`).join(", ")),a),[]))}),window.addEventListener("keydown",i=>{})}function W(...s){}function As(...s){console.debug(...s)}const I=N({range:P.ui8,turnsSinceLastObserve:P.ui8,turnsToSkip:P.ui8,accuracy:P.i8}),$=N({duration:P.ui8}),E=N({turnsSinceLastMove:P.ui8,turnsToSkip:P.ui8,direction:P.ui8}),oi=32,O=N({target:P.eid,path:[P.i16,oi],offset:P.ui8}),it=N({source:P.ui8}),z=N({pressed:P.ui8}),Fs=N({herding:P.ui8}),ai=N({territorial:P.ui8}),Xt=N({hiding:P.ui8}),V=N({deplacable:P.ui8,healRate:P.ui8}),A=N({deplaced:P.i8});function Ds(s,t){let e=t.minus(s).x,i=t.minus(s).y*-1,n=Ns(Math.atan2(i,e));return n*=-1,n+=90,n<0?n+360:n}function Ns(s){return s*180/Math.PI}function Bs(s){return s<0&&(s=s%360+360),["N","E","S","W"][Math.round(s/(360/4))%4]}function Us(s){switch(s){case"N":return 0;case"E":return 1;case"S":return 2;case"W":return 3;default:throw new Error("Invalid cardinal direction: "+s)}}function we(s,t){return Us(Bs(Ds(s,t)))}function xt(s,t){return!t.dinos.at(s)&&li(s,t)}function li(s,t){let e=t.map.at(s);return!(e instanceof kt)&&!(e instanceof k)}function js(s,t,e){return t>=s.x&&t<=s.x+s.w&&e>=s.y&&e<=s.y+s.h}function Q(s,t=.3){if(t<0||t>1)throw"Amount must be between 0 and 1";let e=Math.floor(t*255).toString(16);return Y.toHex(Y.multiply(Y.fromString("#"+e+e+e),Y.fromString(s)))}function Vs(s,t=.3){if(t<0||t>1)throw"Amount must be between 0 and 1";let e=Math.floor(t*255).toString(16);return Y.toHex(Y.add(Y.fromString("#"+e+e+e),Y.fromString(s)))}const X=300,$s=55,gt=5,Le=70,re=2,Ws=["①","②","③","④","⑤","⑥"],qs=["#69A1B5","#A1663B","#E2A651","#C94A24","#79547D"],Gs="#eee";class B extends de{constructor(e,i,n,r,o){super(e,i,{ch:"𑿋",fg:"lightgrey"});g(this,"id");g(this,"dominance");g(this,"kind");g(this,"dead",!1);this.id=n,this.dominance=r,this.kind=o}getVisual(){if(this.dead)return{...super.getVisual(),ch:"%",fg:"lightgrey"};let e={ch:"X",fg:this.id===0?Gs:qs[this.dominance-1]};if(e.ch=Ws[this.dominance-1],D(this.getLevel().dinoEcsWorld,Xt,this.id)){let i=super.getVisual().fg,n=this.getLevel().map.at(this.getXY()).getVisual().fg,r=Y.toHex(Y.interpolate(Y.fromString(i),Y.fromString(n),.5));return{...e,fg:r}}else return e}getSpeed(){return this.dominance}moveTo(e){const i=this.getLevel().map.at(this.getXY());E.direction[this.id]=we(this.getXY(),e),this.getLevel().dinos.remove(this),this.setPosition(e);const n=this.getLevel().map.at(this.getXY());if(this.getLevel().dinos.add(this),!i||!n){console.warn("from",i,"to",n);return}i instanceof L&&!(n instanceof L)&&(E.turnsToSkip[this.id]-=re),!(i instanceof L)&&n instanceof L&&(E.turnsToSkip[this.id]+=re),D(this.getLevel().terrainEcsWorld,V,i.id)&&(R(this.getLevel().terrainEcsWorld,A,i.id),A.deplaced[i.id]=100)}}class Hs{constructor(t={}){g(this,"_ids");g(this,"_qt");g(this,"_index");this._ids=new Map,this._qt=new Yt({width:X,height:X,x:0,y:0,maxObjects:30,maxLevels:8,...t}),this._index=new Map}get(t){return this._ids.get(t)}at(t,e){let i=typeof t=="number"&&typeof e=="number"?new v(t,e):t;return this._index.get(i.toString())||null}add(t){this._qt.insert(t),this._index.set(t.getXY().toString(),t),this._ids.set(t.id,t)}remove(t){this._qt.remove(t),this._index.delete(t.getXY().toString()),this._ids.delete(t.id)}nearest(t){return this._qt.retrieve(new At({x:t.x,y:t.y,r:1})).sort((i,n)=>i.getXY().dist(t)-n.getXY().dist(t))}withIn(t){const e=new He({x:t.x,y:t.y,width:t.w,height:t.h});return this._qt.retrieve(e).filter(i=>{const{x:n,y:r}=i.getXY();return n>=t.x&&n<=t.x+t.w&&r>=t.y&&r<=t.y+t.h})}size(){return this._ids.size}}const hi=new Yt({width:X,height:X,x:0,y:0,maxObjects:30,maxLevels:8}),Ks=s=>{for(let t of hi.retrieve(s))x.getUniform()<.9||t.flow()},Qs=s=>{hi.insert(s)},tt={init:Js,length:Zs,push:tn,current:en,advance:sn};function Js(s){O.path[s]=new Int16Array(oi).fill(-1),O.offset[s]=0}function Zs(s){let t=O.path[s].indexOf(-1);return t===-1?0:(t-O.offset[s])/2}function tn(s,t,e){let i=O.path[s],n=O.path[s].indexOf(-1);i[n]=t,i[n+1]=e}function en(s){return[O.path[s][O.offset[s]],O.path[s][O.offset[s]+1]]}function sn(s){O.offset[s]+=2}function nn(s,t,e){R(s,O,t),O.target[t]=e.id}function It(s,t){D(s,O,t)&&F(s,O,t)}function Xe(s,t,e){R(s,it,t),it.source[t]=e}function rn(s,t){D(s,it,t)&&F(s,it,t)}function on(s){an(s),ot([it,O])(s).length>0&&console.error("Unexpectedly found dinos with Flee and Pursue!");const t=ot([E,O,ie($)]);for(let i of t(s))E.turnsSinceLastMove[i]+=1,!(E.turnsSinceLastMove[i]<=E.turnsToSkip[i]+1)&&(E.turnsSinceLastMove[i]=0,ln(s,i));const e=ot([E,it,ie($)]);for(let i of e(s))E.turnsSinceLastMove[i]+=1,!(E.turnsSinceLastMove[i]<=E.turnsToSkip[i])&&(E.turnsSinceLastMove[i]=0,hn(s,i));return s}const ci=parseInt("0001",2),ui=parseInt("0010",2),fi=parseInt("0100",2),di=parseInt("1000",2),oe=parseInt("10000",2);function an(s){if(s.level.playerDino.dead)return;const t=s.level.playerId;if(E.turnsSinceLastMove[t]+=1,E.turnsSinceLastMove[t]<=E.turnsToSkip[t])return;if(E.turnsSinceLastMove[t]=0,oe&z.pressed[t]){z.pressed[t]=0;return}let e=null;if(ci&z.pressed[t]&&(e=C[4][0]),ui&z.pressed[t]&&(e=C[4][1]),fi&z.pressed[t]&&(e=C[4][2]),di&z.pressed[t]&&(e=C[4][3]),!e)return;z.pressed[t]=0;let i=new v(...e);const n=s.level.playerDino.getXY().plus(i);let r=s.level.dinos.at(n);if(r&&r.dominance<s.level.playerDino.dominance){F(s,E,r.id),F(s,I,r.id),F(s,z,r.id),r.dead=!0;return}xt(n,s.level)&&(s.level.playerDino.moveTo(n),s.level.viewportOffset=s.level.viewportOffset.plus(i))}function Ye(s,t=!1){if(t){switch(s){case" ":z.pressed[this.playerId]&=~oe,F(this.dinoEcsWorld,Xt,this.playerId);break}return}switch(s){case" ":z.pressed[this.playerId]|=oe,R(this.dinoEcsWorld,Xt,this.playerId);break;case"ArrowUp":z.pressed[this.playerId]|=ci;break;case"ArrowRight":z.pressed[this.playerId]|=ui;break;case"ArrowDown":z.pressed[this.playerId]|=fi;break;case"ArrowLeft":z.pressed[this.playerId]|=di;break}}function ln(s,t){const e=O.target[t];let i=s.level.dinos.get(t),n=s.level.dinos.get(e);if(!i)return;if(!n){It(s,t);return}(O.offset[t]===0||tt.length(t)<5)&&Gt(i,n);let r=new v(...tt.current(t));if(r.x===-1){console.error("empty pursue path",t,e),It(s,t);return}W(i.id,"pursuing",n.id,"distance:",tt.length(i.id));let o=we(i.getXY(),r),a=i.getXY().plus(new v(...C[4][o]));if(!r.is(a)){xt(a,s.level)?i.moveTo(a):(Gt(i,n,4),i.moveTo(a),Gt(i,n));return}if(r.is(n.getXY())){if(W(i.id,"reached prey",n.id),F(s,E,e),F(s,I,e),F(s,z,e),n.dead=!0,n===s.level.playerDino){s.level._triggerGameOver();return}It(s,t),R(s,$,t),$.duration[t]=n.dominance*5;return}if(xt(r,s.level)){i.moveTo(r),tt.advance(t);return}}let Ot=new v(0,0);function Gt(s,t,e=8){tt.init(s.id);var i=(r,o)=>{var a;return Ot.x=r,Ot.y=o,li(Ot,s.getLevel())&&!((a=s.getLevel().dinos.at(Ot))!=null&&a.dead)},n=new Ge.AStar(t.getXY().x,t.getXY().y,i,{topology:e});n.compute(s.getXY().x,s.getXY().y,(r,o)=>{tt.push(s.id,r,o)}),tt.advance(s.id)}function hn(s,t){const e=s.level.dinos.get(t);if(!e)return;let n=(it.source[t]+2)%4,r=e.getXY().plus(new v(...C[4][n]));if(xt(r,s.level))e.moveTo(r);else{let o=C[4][Math.abs(n+x.getItem([1,-1]))%4],a=e.getXY().plus(new v(...o));xt(a,s.level)&&e.moveTo(a)}}function cn(s){const t=ot([$]);for(let i of t(s))$.duration[i]-=1,$.duration[i]<=0&&F(s,$,i);const e=ot([I,ie($)]);for(let i of e(s)){const n=s.level.dinos.get(i);if(!n||!js(s.level.getViewport(),n.getXY().x,n.getXY().y))continue;if(I.turnsSinceLastObserve[i]+=1,I.turnsSinceLastObserve[i]<=I.turnsToSkip[i]){W(i,"cooldown",I.turnsSinceLastObserve[i],"until",I.turnsToSkip[i]);continue}I.turnsSinceLastObserve[i]=0,rn(s,n.id),It(s,n.id);let r=0,o=null;n.kind==="PREDATOR"&&(o=fn(s.level.dinos.nearest(n.getXY()),n),o&&(r=15));const a=un(n,s);if(r>=Math.max(...a.map(Math.abs)))return o&&(W(n.id,"going to pursue",o.id),nn(s,n.id,o)),s;const l=a.reduce(([c,u],p,d)=>Math.abs(p)>Math.abs(c)?[p,d]:[c,u],[0,0])[1];if(a[l]<0)Xe(s,n.id,l),W(n.id,"going to flee",l);else{let c=(l+2)%4;Xe(s,n.id,c),W(n.id,"going to wander",l)}return s}}function un(s,t){const e=I.range[s.id];if(e>20)throw new Error(s.id+" Awareness range too high"+e);let i=[0,0,0,0],n=0;return new Qi.PreciseShadowcasting(()=>!0).compute(s.getXY().x,s.getXY().y,e,(o,a,l,h)=>{if(o<0||a<0||o>=X||a>=X)return;const c=t.level.getEntity(o,a);if(c===s)return;n=we(s.getXY(),c.getXY());const u=s.getXY().dist(c.getXY());c instanceof B?((c.kind="PREDATOR")&&c.dominance>s.dominance&&pi(s,c)&&(i[n]+=-1*Ht(s.getXY(),c.getXY())),s.kind==="PREDATOR"&&D(t,ai,s.id)&&c.dominance===s.dominance&&(i[n]+=-4*Ht(s.getXY(),c.getXY())),c.dominance===s.dominance&&u>2&&(i[n]+=2)):c instanceof k&&(i[n]+=-.3*Ht(s.getXY(),c.getXY()))}),i}function fn(s,t){let e=null;for(let i of s){if(i.id===t.id||i.dead||!pi(t,i))continue;if(W(t.id,"considering",i.id),t.getXY().dist(i.getXY())>I.range[t.id]*2)break;if(i.dominance>=t.dominance)continue;if(!e){e=i;continue}let r=0;if(i.dominance>e.dominance&&(r+=i.dominance-e.dominance),r-=Math.floor(i.getXY().dist(e.getXY())/2),r>0)e=i,W(t.id,"found better option",e.id);else{W(t.id,"stopping search, going after",e.id);break}}return e}function pi(s,t){let e=I.accuracy[s.id];return D(s.getLevel().dinoEcsWorld,Xt,t.id)&&(e*=.5),x.getPercentage()<e}function Ht(s,t){const e=s.dist(t);return e<=5?3:e<=7?2:1}function dn(s){const t=ot([A,V]);for(let e of t(s)){A.deplaced[e]-=V.healRate[e],A.deplaced[e]<=0&&F(s,A,e);let i=A.deplaced[e],n=s.level.map.getById(e).getXY(),r=[n.plus(new v(0,1)),n.plus(new v(0,-1)),n.plus(new v(1,0)),n.plus(new v(-1,0))];for(let o of r){let a=s.level.map.at(o);i>0&&a instanceof L&&!D(s,A,a.id)&&(R(s,A,a.id),A.deplaced[a.id]=Math.floor(i/4))}}}class be{constructor(t){g(this,"viewportSize");g(this,"viewportOffset");g(this,"map");g(this,"dinos");g(this,"scheduler");g(this,"textBuffer");g(this,"playerId");g(this,"playerDino");g(this,"game");g(this,"terrainEcsWorld");g(this,"dinoEcsWorld");g(this,"paused",null);g(this,"whenRunning",Promise.resolve());g(this,"_fovCells",[]);this.game=t,this.map=new pe(X,X),this.dinos=new Hs({width:X,height:X}),this.viewportSize=new v(0,0),this.scheduler=new qi.Speed,this.terrainEcsWorld=Re({level:this}),this.dinoEcsWorld=Re({level:this}),this.playerId=qt(this.dinoEcsWorld),R(this.dinoEcsWorld,z,this.playerId),R(this.dinoEcsWorld,E,this.playerId),E.turnsToSkip[this.playerId]=0,this.playerDino=new B(this,new v,this.playerId,2,"PREDATOR"),this.dinos.add(this.playerDino),this._generateMap(),this._generateMobs(),this.drawMap(),this.textBuffer=new ss(this.game);let e=this.getSize(),i=3;this.textBuffer.configure({position:new v(0,0),size:new v(e.x,i)}),this.textBuffer.clear(),Ys(this),this.waterLoop(),this.lavaloop(),this.mainLoop()}waterLoop(){const e=new He({x:this.viewportOffset.x,y:this.viewportOffset.y,width:this.viewportSize.x,height:this.viewportSize.y}),i=()=>{e.x=this.viewportOffset.x,e.y=this.viewportOffset.y,e.width=this.viewportSize.x,e.height=this.viewportSize.y,Ks(e),setTimeout(()=>this.whenRunning.then(i),200)};i()}lavaloop(){const e=()=>{for(let i of[...this.map.getTagged(k)]){if(x.getPercentage()<90)continue;let{x:n,y:r}=i.getXY(),o=this.map.at(n,r-1),a=this.map.at(n,r+1),l=this.map.at(n-1,r),h=this.map.at(n+1,r),c=new Set([o,a,l,h].filter(u=>u));for(let u of c){if(u instanceof k||u instanceof kt){c.delete(u);continue}let p=50;if(u instanceof nt&&(p=10),u instanceof Ct&&(p=7),u instanceof Wt&&(p=3),u instanceof L&&(p=1),x.getPercentage()<=p){let d=new k(this,u.getXY());this.map.set(d,!0),this.map.removeFromIndex(u);let f=this.dinos.at(d.getXY());if(f){if(f.dead=!0,f===this.playerDino){this._triggerGameOver();return}this.dinos.remove(f)}}}if(c.size===0){this.map.removeFromIndex(i);let u=x.getItem("¸ʾ˚˓".split(""));i.setVisual({ch:u})}}setTimeout(()=>this.whenRunning.then(e),70)};e()}async mainLoop(){const e=()=>{this.viewportSize.x<=$s&&(this.viewportSize.x+=4,this.viewportSize.y+=4,this.viewportOffset.x-=2,this.viewportOffset.y-=2,this.game.display.setOptions({width:this.getSize().x,height:this.getSize().y})),cn(this.dinoEcsWorld),on(this.dinoEcsWorld),dn(this.terrainEcsWorld),this.drawMap(),setTimeout(()=>this.whenRunning.then(e),100)};e()}onClick(t){if(this.textBuffer.clear(),this.textBuffer.showing){this.textBuffer.clearDisplayBox();return}this.game.display.eventToPosition(t)}onKeyDown(t){this.paused&&t.key.toLowerCase()!=="p"||(this.textBuffer.clear(),this.textBuffer.showing&&t.key==="Enter"?this.textBuffer.clearDisplayBox():t.key.toLowerCase()==="d"?this.handlePause(!0):t.key.toLowerCase()==="p"?this.handlePause():["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(t.key)&&Ye.call(this,t.key))}onKeyUp(t){["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(t.key)&&Ye.call(this,t.key,!0)}handlePause(t=!1){var r;let e=this.getSize(),i=this.viewportOffset;this.paused?(this.paused(!0),this.paused=null,(r=document.querySelector("#status"))==null||r.classList.add("hidden")):(this.whenRunning=new Promise((o,a)=>this.paused=o),document.querySelector("#status").innerHTML="PAUSED",document.querySelector("#status").classList.remove("hidden"),t||(this.viewportSize=this.map.size,this.viewportOffset=new v(0,0)));let n=this.getSize();this.game.display.setOptions({width:n.x,height:n.y}),this.drawMap(),this.viewportSize=e,this.viewportOffset=i}draw(t){let e=t instanceof de?t:this.map.at(t);if(!e)throw new Error("No entity to draw for "+t.toString());let{x:i,y:n}=e.getXY().minus(this.viewportOffset),{ch:r,fg:o}=e.getVisual(),a=o;e instanceof B&&e.dead&&(a=this.map.at(e.getXY()).getVisual().fg),D(this.terrainEcsWorld,A,e.id)&&(o=e instanceof L?Vs(o,.3):Q(o,.7)),this.game.display.draw(i,n,r,o,Q(a))}drawMap(){for(let t of this.map.get(this.getViewport()))t=this.dinos.at(t.getXY())||t,this.draw(t);for(let t of this.dinos.withIn(this.getViewport()))t.dead?this.drawSkeleton(t):this.drawDino(t)}drawSkeleton(t){var h,c;let e=t.id%4,i="/",n=new v(...C[4][e]),r=t.getXY().minus(n);if(!(this.getEntity(r.x,r.y)instanceof B)){let u=Q((h=this.map.at(r))==null?void 0:h.getVisual().fg);r=r.minus(this.viewportOffset),this.game.display.draw(r.x,r.y,i,t.getVisual().fg,u)}let o="o",a=new v(...C[4][(e+2)%4]),l=t.getXY().minus(a);if(!(this.getEntity(l.x,l.y)instanceof B)){let u=Q((c=this.map.at(l))==null?void 0:c.getVisual().fg);l=l.minus(this.viewportOffset),this.game.display.draw(l.x,l.y,o,t.getVisual().fg,u)}}drawDino(t){var b,S,M,y;let e=E.direction[t.id],i=["⏶","⏵","⏷","⏴"][e],n=new v(...C[4][(e+2)%4]),r=t.getXY().minus(n),o=Q((b=this.map.at(r))==null?void 0:b.getVisual().fg);if(this.getEntity(r.x,r.y)instanceof B||(r=r.minus(this.viewportOffset),this.game.display.draw(r.x,r.y,i,t.getVisual().fg,o)),this.map.at(t.getXY().x,t.getXY().y)instanceof L||!D(this.dinoEcsWorld,E,t.id))return;let a=["⇂","↼","↾","⇁"][e],l=["↲","↜","↱","↝"][e],h=new v(...C[4][e]),c=t.getXY().minus(h);if(!(this.getEntity(c.x,c.y)instanceof B)){o=Q((S=this.map.at(c))==null?void 0:S.getVisual().fg),c=c.minus(this.viewportOffset);let T=x.getPercentage()<20?l:a;this.game.display.draw(c.x,c.y,T,t.getVisual().fg,o)}let u=(t.getXY().x+t.getXY().y)%2,p=["'","-"],d=e%2?p[u]:p[1-u],f=new v(...C[4][(e+1)%4]),_=t.getXY().minus(f);this.getEntity(_.x,_.y)instanceof B||(o=Q((M=this.map.at(_))==null?void 0:M.getVisual().fg),_=_.minus(this.viewportOffset),this.game.display.draw(_.x,_.y,d,t.getVisual().fg,o));let w=new v(...C[4][(e+3)%4]),m=t.getXY().minus(w);this.getEntity(m.x,m.y)instanceof B||(o=Q((y=this.map.at(m))==null?void 0:y.getVisual().fg),m=m.minus(this.viewportOffset),this.game.display.draw(m.x,m.y,d,t.getVisual().fg,o))}getEntity(t,e){return this.dinos.at(t,e)||this.map.at(t,e)}getSize(){return this.viewportSize}updateFOV(){for(;this._fovCells.length;)this.draw(this._fovCells.pop())}getViewport(){return{x:this.viewportOffset.x,y:this.viewportOffset.y,w:this.viewportSize.x,h:this.viewportSize.y}}_generateMap(){var u;let t=[k,lt,nt,L,nt,Ct,Wt];const e=new ts;let i=(p,d,f,_=3,w=1)=>{if(_===0)return 0;var m=e.get(p/f,d/f)*w;let b=.5;return m+i(p,d,f*b,_-1,w*b)};const n=X,r=X,o=120,a=new v(n/2,r/2),l=a.plus(new v(x.getUniformInt(.5,1)*x.getItem([1,-1])*n/5,x.getUniformInt(.5,1)*x.getItem([1,-1])*r/5));for(var h=0;h<r;h++)for(var c=0;c<n;c++){let p=a.dist(new v(c,h)),d=l.dist(new v(c,h)),f=1-p/(n/2),_=1-d/(n/5),w=i(c,h,o,5);w=w+1.5,f*=.5,_*=.3;let m=Math.max(0,f)+Math.max(0,_),b=Math.min(m*255,255)*w;b=9-Math.round(b/30);let S=t[b]||kt;b<0&&(S=S=k);let M=new S(this,new v(c,h)),y=qt(this.terrainEcsWorld);M.id=y,S===nt&&(R(this.terrainEcsWorld,V,y),V.healRate[y]=15),S===Ct&&(R(this.terrainEcsWorld,V,y),V.healRate[y]=10),S===L&&(R(this.terrainEcsWorld,V,y),V.healRate[y]=10);let T=t.includes(S);this.map.set(M,T),"flow"in M&&Qs(M)}if(this.map.getTagged(k).size===0){let p=this.map.getTagged(lt);p.size||(console.debug("No Dirt found for lava, using Grass instead"),p=this.map.getTagged(nt));let d=(u=x.getItem([...p]))==null?void 0:u.getXY();d&&this.map.set(new k(this,d),!0)}}_generateMobs(){let e=[nt,L,Ct,Wt].flatMap(f=>[...this.map.getTagged(f)].map(_=>_.getXY()));const i=3,n=10,r=1,o=x.shuffle(e),a=x.shuffle(["HERBIVORE","HERBIVORE","PREDATOR","PREDATOR","PREDATOR"]),l=new Array(gt).fill(0).map((f,_)=>.5+_/(gt-1)).map(f=>Math.floor(f*Le/gt)),h=(f,_,w)=>{let m=qt(this.dinoEcsWorld);R(this.dinoEcsWorld,I,m),I.range[m]=n,I.turnsToSkip[m]=i,I.accuracy[m]=70,R(this.dinoEcsWorld,E,m),E.turnsToSkip[m]=r;for(let M of w)R(this.dinoEcsWorld,M,m);const b=o.pop();this.map.at(b)instanceof L&&(E.turnsToSkip[m]+=re);let S=new B(this,b,m,f,_);this.dinos.add(S)},c=(f,_)=>{let w=l.shift(),m="PREDATOR";f===gt?(w=Math.floor(w/2),m="PREDATOR"):f===1?(w=_,m="HERBIVORE"):(m=a.shift(),a.push(m));const b=[];f<=3&&b.push(Fs),f===5&&b.push(ai);for(let S=0;S<w;S++)h(f,m,b);As(`Generated ${w} dinosaurs at level ${f} of kind ${m}`),f>1&&c(f-1,_-w)};c(gt,Le);const u=[...this.map.getTagged(k)][0].getXY();let p=(f,_)=>!(this.map.at(f,_)instanceof kt),d=0;for(;d===0&&o.length>0;){let f=o.pop();new Ge.AStar(u.x,u.y,p,{topology:4}).compute(f.x,f.y,()=>d+=1),d||console.log("No path to lava"),d&&(this.playerDino.moveTo(f),this.viewportOffset=this.playerDino.getXY().minus(this.viewportSize.div(2)))}}_triggerGameOver(){this.game.switchLevel(new rs(this.game))}}class pn{constructor(){g(this,"level");g(this,"display");g(this,"HANDLED_KEYS",["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","w","a","s","d","Enter","Escape"," "]);g(this,"_container");let e=window.innerWidth/50;window.addEventListener("resize",()=>{e=window.innerWidth/50,this.display.setOptions({fontSize:e})}),this.display=new ht({fontSize:e}),this._container=this.display.getContainer(),this._container.classList.add("max-h-screen","max-w-full"),document.body.appendChild(this._container);let i=new Ke(this);this.level=i,this.switchLevel(i),window.addEventListener("keydown",this.onKeyDown.bind(this)),window.addEventListener("keyup",this.onKeyUp.bind(this)),this.detectMobile()&&this._container.addEventListener("touchstart",this.onClick.bind(this))}detectMobile(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}onClick(t){this.level.onClick(t)}onKeyDown(t){this.HANDLED_KEYS.includes(t.key)&&t.preventDefault(),this.level.onKeyDown(t)}onKeyUp(t){this.HANDLED_KEYS.includes(t.key)&&t.preventDefault(),this.level.onKeyUp(t)}switchLevel(t){this.level=t;let e=t.getSize();if(this.display.setOptions({width:e.x,height:e.y,forceSquareRatio:!0,fontFamily:"Sans-serif",bg:"#111",spacing:.9}),t instanceof be&&this.detectMobile()){let i=document.getElementById("pause");i.style.display="block",i.addEventListener("touchstart",()=>this.onKeyDown(new KeyboardEvent("keydown",{key:"p",keyCode:80})));let n=null,r=null,o=()=>{switch(n){case"up":this.onKeyDown(new KeyboardEvent("keydown",{key:"ArrowUp",keyCode:38}));break;case"down":this.onKeyDown(new KeyboardEvent("keydown",{key:"ArrowDown",keyCode:40}));break;case"left":this.onKeyDown(new KeyboardEvent("keydown",{key:"ArrowLeft",keyCode:37}));break;case"right":this.onKeyDown(new KeyboardEvent("keydown",{key:"ArrowRight",keyCode:39}));break}},a=document.getElementById("virtual-joystick");a.style.display="flex",a.addEventListener("touchstart",l=>{var h;n=(h=l.target)==null?void 0:h.id,o(),r=setInterval(o,200)}),a.addEventListener("touchend",l=>{n=null,clearInterval(r)})}}}window.addEventListener("load",gn);function gn(s){var t;s.type==="load"&&((t=document.querySelector("#status"))==null||t.classList.add("hidden","absolute","top-32","z-10"),new pn)}new AudioContext;
